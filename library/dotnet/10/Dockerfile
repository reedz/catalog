FROM --platform=linux/x86_64 mcr.microsoft.com/dotnet/sdk:10.0-preview AS build

# Install native build tools required for AOT compilation
RUN apt-get update && apt-get install -y \
    clang \
    zlib1g-dev \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /src

COPY ./Program.cs /src/Program.cs
COPY ./SimpleHttpServer.csproj /src/SimpleHttpServer.csproj

RUN dotnet publish -c Release -r linux-x64 -o /app

FROM alpine:3 AS sys

RUN set -xe; \
    mkdir -p /target/etc; \
    mkdir -p /blank; \
    apk --no-cache add \
      ca-certificates \
      tzdata \
    ; \
    update-ca-certificates; \
    ln -sf ../usr/share/zoneinfo/Etc/UTC /target/etc/localtime; \
    echo "Etc/UTC" > /target/etc/timezone;

FROM scratch

COPY --from=sys /target/etc /etc
COPY --from=sys /usr/share/zoneinfo/Etc/UTC /usr/share/zoneinfo/Etc/UTC
COPY --from=sys /etc/ssl/certs/ca-certificates.crt /etc/ssl/certs/ca-certificates.crt
COPY --from=sys /blank /tmp

COPY --from=build /app/SimpleHttpServer /usr/src/SimpleHttpServer
